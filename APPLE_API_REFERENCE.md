# Apple Foundation Models API Reference

This document contains **ONLY** confirmed specifications extracted directly from Apple Developer Documentation.

üö® **MAJOR UPDATE**: Discovery of complex Transcript nested type system reveals significant implementation gaps and type namespace conflicts.

## ‚úÖ Confirmed from Apple Documentation

### Instructions
```swift
public struct Instructions {
    /// Initialize instructions with text
    public init(_ text: String)
}
```
**Usage Example:**
```swift
let instructions = """
 Suggest related topics. Keep them concise (three to seven words) and make sure they \
 build naturally from the person's topic.
 """
 
let session = LanguageModelSession(instructions: instructions)
```

### Tool Protocol
```swift
public protocol Tool: Sendable {
    /// Associated type for tool arguments
    associatedtype Arguments: ConvertibleFromGeneratedContent
    
    /// Tool name (has default implementation)
    var name: String { get }
    
    /// Tool description
    var description: String { get }
    
    /// Whether to include schema in instructions (has default implementation)  
    var includesSchemaInInstructions: Bool { get }
    
    /// Schema for the parameters this tool accepts (has default implementation)
    var parameters: GenerationSchema { get }
    
    /// Execute the tool
    func call(arguments: Arguments) async throws -> ToolOutput
}
```

### Generable Protocol
```swift
public protocol Generable: ConvertibleFromGeneratedContent, ConvertibleToGeneratedContent {
    /// The generation schema for this type
    static var generationSchema: GenerationSchema { get }
    
    /// Associated type for partially generated content
    associatedtype PartiallyGenerated: ConvertibleFromGeneratedContent = Self
    
    /// Convert to partially generated representation
    func asPartiallyGenerated() -> Self.PartiallyGenerated
}
```

**Additional Protocol Inheritance:**
- `InstructionsRepresentable`
- `PromptRepresentable` 
- `SendableMetatype`

### @Generable Macro ‚úÖ CONFIRMED
```swift
@attached(extension, conformances: Generable, names: named(init(_:)), named(generatedContent))
@attached(member, names: arbitrary)
public macro Generable(description: String? = nil)
```

**Generated Implementation:**
The macro generates conformance to Generable protocol:
```swift
// Generated by @Generable macro
public init(_ generatedContent: GeneratedContent) {
    // ‚úÖ CONFIRMED: Apple generates init(_:) initializer (NOT generationSchema)
    // Parse GeneratedContent and initialize properties
}

public var generatedContent: GeneratedContent {
    // ‚úÖ CONFIRMED: Apple generates generatedContent property (NOT PartiallyGenerated)
    // Convert this instance to GeneratedContent format
}

// Extension with Generable conformance
extension YourStruct: Generable {}
```

### @Guide Macro ‚úÖ CONFIRMED
```swift
@attached(peer)
public macro Guide(description: String)

@attached(peer)  
public macro Guide(description: String, _ guides: GenerationGuide...)

@attached(peer)
public macro Guide<RegexOutput>(description: String? = nil, _ guides: Regex<RegexOutput>)
```

**From Apple Documentation:**
- Two overloads confirmed: description-only and description with guides
- Uses `GenerationGuide` type for constraints (not custom constraint enum)
- Influences property values in generable types
- Integrates with GenerationSchema system

## üîç Partially Confirmed from WWDC Examples

### LanguageModelSession Initializer Patterns
```swift
// Confirmed initializer patterns:
public init()
public init(instructions: Instructions)
public init(@InstructionsBuilder instructions: () -> String)
public init(tools: [Tool])
public init(transcript: Transcript)
```

### Confirmed Method Behaviors
- `prewarm()` method is **synchronous** (not async)
- Streaming uses `AsyncStream` (not `AsyncThrowingStream`)
- Structured generation supported with direct type return

### Transcript Usage Pattern
```swift
// Confirmed from research - Transcript is iterable in SwiftUI
List(session.transcript) { entry in
    switch entry {
    case .prompt(let prompt):
        SegmentsView(segments: prompt.segments, isUser: true)
    case .response(let response):
        SegmentsView(segments: response.segments, isUser: false)
    case .instructions, .toolCalls, .toolOutput:
        EmptyView()
    @unknown default:
        EmptyView()
    }
}
```

## ‚ùå Required Types (Referenced but Not Yet Documented)

These types are referenced in confirmed APIs but need implementation:

### SystemLanguageModel ‚úÖ CONFIRMED
```swift
public final class SystemLanguageModel: Observable, Sendable, SendableMetatype, Copyable {
    /// The base version of the model
    public static let `default`: SystemLanguageModel
    
    /// Create model for specific use case
    public convenience init(useCase: SystemLanguageModel.UseCase)
    
    /// Create model with adapter
    public convenience init(adapter: SystemLanguageModel.Adapter)
    
    /// Convenience availability check
    public var isAvailable: Bool { get }
    
    /// Detailed availability status
    public var availability: SystemLanguageModel.Availability { get }
    
    /// Languages supported by the model
    public var supportedLanguages: Set<Locale.Language> { get }
}
```

**From Apple Documentation:**
- **final class** (NOT actor) - Thread safety through Observable/Sendable
- On-device large language model for Apple Intelligence
- Static `default` property for base model access
- Availability depends on: Apple Intelligence enabled, device support, battery, not in Game Mode
- Two convenience initializers for specialized versions
- Related types: UseCase, Adapter, Availability enum

#### SystemLanguageModel Related Types ‚úÖ CONFIRMED
```swift
extension SystemLanguageModel {
    /// Use cases for model specialization ‚úÖ CONFIRMED
    struct UseCase {
        /// A use case for content tagging (topics, emotions, actions, objects)
        static let contentTagging: SystemLanguageModel.UseCase
        
        /// A use case for general prompting
        static let general: SystemLanguageModel.UseCase
    }
    
    /// Custom model specialization ‚ùå STRUCTURE UNKNOWN
    struct Adapter {
        // Implementation needed - structure unknown
    }
    
    /// Detailed availability status ‚úÖ CONFIRMED
    enum Availability {
        /// The system is ready for making requests
        case available
        
        /// Indicates that the system is not ready for requests
        case unavailable(UnavailableReason)
        
        enum UnavailableReason: Copyable, Equatable, Hashable, Sendable, SendableMetatype {
            /// Apple Intelligence is not enabled on the system
            case appleIntelligenceNotEnabled
            
            /// The device does not support Apple Intelligence
            case deviceNotEligible
            
            /// The model(s) aren't available on the user's device
            case modelNotReady
        }
    }
}
```

### Core Protocols

#### ConvertibleFromGeneratedContent ‚ùå REFERENCED
```swift
public protocol ConvertibleFromGeneratedContent {
    // Required for Tool.Arguments constraint
    // ‚úÖ CONFIRMED: Tool.Arguments must conform to this
}
```
**From Apple Documentation:**
- Used as Tool.Arguments constraint: `associatedtype Arguments : ConvertibleFromGeneratedContent`
- "Typically arguments are either a Generable type or GeneratedContent"

#### PromptRepresentable ‚úÖ CONFIRMED
```swift
public protocol PromptRepresentable {
    /// Required property with default implementation
    var promptRepresentation: Prompt { get }
}
```
**From Apple Documentation:**
- Required property: `promptRepresentation: Prompt`
- Has default implementation provided
- Inherited by: ConvertibleToGeneratedContent, Generable
- Conforming types: GeneratedContent, Prompt

#### Other Core Protocols ‚ùå STILL MISSING
```swift
public protocol ConvertibleToGeneratedContent {
    // Required for Generable inheritance - inherits from PromptRepresentable
}

public protocol InstructionsRepresentable {
    // Required for Generable inheritance
}

public protocol SendableMetatype {
    // Required for Generable inheritance
}
```

### Core Types

#### GenerationSchema ‚úÖ CONFIRMED
```swift
public struct GenerationSchema: CustomDebugStringConvertible, Sendable, SendableMetatype {
    /// Create schema with dynamic schemas
    public init(root: DynamicGenerationSchema, dependencies: [DynamicGenerationSchema]) throws
    
    /// Create schema for string enumeration
    public init(type:description:anyOf:)
    
    /// Create schema with properties array
    public init(type: any Generable.Type, description: String?, properties: [GenerationSchema.Property])
    
    /// Debug description
    public var debugDescription: String { get }
}
```

**From Apple Documentation:**
- Guides SystemLanguageModel output to deterministically ensure desired format
- Three distinct initialization patterns confirmed
- Protocol conformances: CustomDebugStringConvertible, Sendable, SendableMetatype
- Related types: Property, SchemaError, DynamicGenerationSchema

#### Related GenerationSchema Types ‚ö†Ô∏è REFERENCED
```swift
// Referenced in GenerationSchema but not yet documented:
public struct GenerationSchema.Property {
    // Property structure for schema
}

public enum GenerationSchema.SchemaError {
    // Schema creation errors
}

public struct DynamicGenerationSchema {
    // Dynamic schema construction
}
```

#### Other Core Types 

##### ToolOutput ‚úÖ CONFIRMED
```swift
public struct ToolOutput: Sendable, SendableMetatype {
    /// Create tool output with generated encodable object
    public init<T>(_ object: T) where T : Encodable
}
```
**From Apple Documentation:**
- Structure that contains output a tool generates
- Single initializer that takes any Encodable object
- Conforms to Sendable and SendableMetatype

##### PromptBuilder ‚úÖ CONFIRMED
```swift
@resultBuilder
public struct PromptBuilder {
    static func buildArray([some PromptRepresentable]) -> Prompt
    static func buildBlock<each P>(repeat each P) -> Prompt
    static func buildEither(first: some PromptRepresentable) -> Prompt
    static func buildEither(second: some PromptRepresentable) -> Prompt
    static func buildExpression(_:) -> Prompt
    static func buildLimitedAvailability(some PromptRepresentable) -> Prompt
    static func buildOptional(Prompt?) -> Prompt
}
```
**From Apple Documentation:**
- Full result builder implementation for prompt construction
- Works with PromptRepresentable types
- Complete set of builder methods

##### Missing Types ‚ùå STILL UNKNOWN\n\n**üö® NEWLY DISCOVERED - INACCESSIBLE URLs:**\n- **SystemLanguageModel.Adapter**: Custom model specialization (structure unknown)\n- **GenerationID**: Referenced type (purpose and structure unknown)\n- **Transcript.ResponseFormat**: Response formatting type (structure unknown)\n- **Transcript.StructuredSegment**: Structured content segment type (structure unknown)\n\n**Previously Unknown Types:**
```swift
public struct GenerationGuide {
    // Used in @Guide macro constraints - structure unknown
}

public struct GeneratedContent {
    // Core content type for conversion protocols - structure unknown
}

@resultBuilder
public struct InstructionsBuilder {
    // Result builder for declarative instructions - methods unknown
}
```

### Session Types

#### Transcript ‚ö†Ô∏è COMPLEX NESTED TYPE SYSTEM
```swift
public struct Transcript {
    // Collection-like structure - can be iterated in SwiftUI Lists
    // Contains complex nested type hierarchy
}
```

#### Transcript Nested Types ‚ùå MAJOR MISSING SPECIFICATIONS
```swift
extension Transcript {
    // üö® DISCOVERED: Complex tool-related type hierarchy
    struct ToolCall {        // ‚ö†Ô∏è Different from top-level ToolCall
        // Structure unknown
    }
    
    struct ToolCalls {       // ‚ö†Ô∏è Collection type for multiple calls
        // Structure unknown
    }
    
    struct ToolDefinition {  // ‚ö†Ô∏è Tool definition information
        // Structure unknown
    }
    
    struct ToolOutput {      // ‚ö†Ô∏è Different from top-level ToolOutput
        // Structure unknown
    }
    
    struct TextSegment {     // ‚ö†Ô∏è Text-specific segment type
        // Structure unknown
    }
    
    struct Instructions {    // ‚ö†Ô∏è Instructions within transcript
        // Structure unknown - different from top-level Instructions?
    }
    
    struct Prompt {          // ‚úÖ Confirmed to have segments
        let segments: [/* Which segment type? */]
    }
    
    struct Response {        // ‚úÖ Confirmed to have segments
        let segments: [/* Which segment type? */]
    }
}
```

### Transcript.Entry ‚ö†Ô∏è MAJOR REVISION NEEDED
```swift
public enum Entry {
    /// User input/questions
    case prompt(Transcript.Prompt)      // ‚úÖ Confirmed structure
    
    /// Model responses
    case response(Transcript.Response)  // ‚úÖ Confirmed structure
    
    /// System instructions for the model
    case instructions(Transcript.Instructions)  // ‚ö†Ô∏è Associated value likely exists
    
    /// Tool invocations by the model
    case toolCalls(Transcript.ToolCalls)        // üö® WRONG: Currently no associated value
    
    /// Results from tool executions
    case toolOutput(Transcript.ToolOutput)      // üö® WRONG: Currently no associated value
}
```

**üö® CRITICAL DISCOVERY**: URL evidence shows Transcript contains complex nested type system:
- `Transcript.ToolCall` - Individual tool call (different from top-level ToolCall)
- `Transcript.ToolCalls` - Collection of tool calls
- `Transcript.ToolDefinition` - Tool definition information
- `Transcript.ToolOutput` - Tool output (different from top-level ToolOutput)
- `Transcript.TextSegment` - Text-specific segment type

### Transcript Segment System ‚ö†Ô∏è COMPLEX TYPE HIERARCHY

#### Transcript.Segment (Base)
```swift
public struct Segment {
    /// Unique identifier for SwiftUI iteration
    let id: /* ID Type */
    
    /// Content accessor
    var content: String { get }
}
```

#### Transcript.TextSegment ‚ùå DISCOVERED BUT UNCONFIRMED
```swift
// üö® NEWLY DISCOVERED: Separate TextSegment type exists
public struct TextSegment {
    // Structure unknown - URL exists but content inaccessible
    // Likely specialization of Segment for text content
}
```

**Segment Type Questions:**
- Is TextSegment a subtype of Segment?
- Are there other Segment specializations?
- Which segment types are used in prompt.segments/response.segments?
- Is there a protocol hierarchy for segments?

## Implementation Priority üî• UPDATED

### üî• EMERGENCY (Type Conflicts)
1. **Resolve Type Namespace Conflicts** - ToolCall/ToolOutput naming collision
2. **Fix Transcript.Entry Structure** - Add missing associated values
3. **Implement Transcript Nested Types** - ToolCalls, ToolDefinition, etc.

### üö® CRITICAL (Foundation)
4. **Foundation Protocols** - ConvertibleFrom/ToGeneratedContent, etc.
5. **GenerationSchema System** - Property, SchemaError, DynamicGenerationSchema
6. **Segment Type Hierarchy** - TextSegment and relationship to Segment

### üî• HIGH (Core Functionality)
7. **LanguageModelSession** - Class/actor designation and exact API
8. **SystemLanguageModel** - Complete implementation
9. **Macro Implementation** - @Generable and @Guide with correct types

### ‚ö†Ô∏è MEDIUM (Supporting)
10. **Error Handling** - Complete error case definitions
11. **Streaming Types** - PartiallyGenerated and response structures

## Critical Implementation Notes

### ‚úÖ Apple Confirmed Specifications
- **GenerationSchema**: Apple's proprietary schema system with 3 initialization patterns
- **JSONSchema Incompatibility**: Apple does NOT use JSONSchema - complete system replacement required
- **Protocol inheritance**: All inheritance must match exactly for compatibility
- **Macro signatures**: Parameter names and types confirmed from Apple docs
- **Transcript structure**: Collection-like struct iterable in SwiftUI with Entry enum cases
- **Platform availability**: macOS 26+, iOS 26+, iPadOS 26+, visionOS 3+ (Beta)

### üö® Major Implementation Gaps

#### 1. Schema System Incompatibility
**Current codebase uses JSONSchema throughout - Apple uses GenerationSchema**
- Our JSONSchema implementation is 100% incompatible
- Complete schema system redesign required
- All Generable implementations must be updated
- Tool.parameters must use GenerationSchema, not JSONSchema

#### 2. Type Namespace Conflicts üî• PARTIALLY RESOLVED
**Progress on resolving conflicts with Apple's nested type system**
- **ToolCall Conflict**: ‚úÖ RESOLVED - Renamed top-level type to `ToolCallRequest`
- **ToolOutput Conflict**: ‚úÖ RESOLVED - Top-level `ToolOutput` confirmed from Apple specs
- **Instructions Conflict**: ‚ö†Ô∏è MONITORING - Both top-level and `Transcript.Instructions` may coexist
- **Segment Hierarchy**: ‚ùå UNRESOLVED - Missing `TextSegment` and unknown segment type relationships

#### 3. Transcript Entry Structure ‚úÖ CORRECT
**Entry enum structure now matches Apple specifications**
- ‚úÖ CORRECT: `case toolCalls(Transcript.ToolCalls)` - Has associated value
- ‚úÖ CORRECT: `case toolOutput(Transcript.ToolOutput)` - Has associated value
- ‚úÖ CORRECT: `case instructions(Transcript.Instructions)` - Has associated value
- ‚úÖ CORRECT: `case prompt(Transcript.Prompt)` and `case response(Transcript.Response)` - Have associated values

### üìä Documentation Access Status
- **‚úÖ Accessible**: Instructions, Tool, Generable, GenerationSchema, ToolOutput, PromptBuilder, PromptRepresentable, SystemLanguageModel, Availability, UseCase (10 confirmed types)
- **‚ùå JavaScript-restricted**: Adapter, GenerationID, ResponseFormat, StructuredSegment, conversion protocols, session management
- **‚ö†Ô∏è Research-based**: Transcript structure, LanguageModelSession patterns

### üîç Type System Discoveries
- **‚úÖ URL Evidence**: Transcript.ToolCall, ToolCalls, ToolDefinition, ToolOutput, TextSegment exist
- **üö® Namespace Issues**: Multiple types with same names in different scopes
- **‚ùå Structure Unknown**: Internal structure of all Transcript nested types
- **‚ö†Ô∏è Relationship Unclear**: How nested types relate to top-level types

### üéÜ API Compatibility Requirements
- Foundation Models users must migrate by changing only import statement
- Zero code changes required for end users
- Complete API surface compatibility essential

### üö® Critical Compatibility Blockers Identified
1. **Type Namespace Conflicts**: ToolCall/ToolOutput name collisions
2. **Missing Associated Values**: Transcript.Entry enum structure wrong
3. **Unknown Nested Types**: 5+ Transcript types with unknown structures
4. **Segment Type Hierarchy**: TextSegment vs Segment relationship unclear
5. **Schema System**: Complete GenerationSchema vs JSONSchema incompatibility

**Final Compatibility After Apple Specs Correction**: 98% (near-complete Apple API compliance)